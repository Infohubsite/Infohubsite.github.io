@inject IEntityDefinitionService EDS
@inject IEntityInstanceService EIS
@inject INotificationService NS
@inject IFileService FS

<MudDialog>
    <DialogContent>
        @if (EntityDefinition == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            @if (error != null)
            {
                <MudAlert Severity="Severity.Error" Class="my-2">@error</MudAlert>
            }

            <MudForm @ref="form" @bind-IsValid="valid" Class="mt-4">
                @foreach (FieldDefinition field in EntityDefinition.Fields)
                {
                    @if (field.IsList)
                    {
                        <div class="my-4">
                            <ChipInput Label="@field.Name" Values="GetListValue(field.Name)" ValuesChanged="StateHasChanged" DataType="field.DataType" Required="field.IsRequired" ReferenceTargetEntityDefinitionId="field.ReferenceTargetEntityDefinitionId" />
                        </div>
                    }
                    else
                    {
                        <FieldDisplay FieldName="@field.Name" DataType="field.DataType" Required="field.IsRequired" @bind-Value="model.Data[field.Name]" ReferenceTargetEntityDefinitionId="field.ReferenceTargetEntityDefinitionId" />
                    }
                }
            </MudForm>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton OnClick="Submit" Color="Color.Primary" Variant="Variant.Filled" Disabled="@(!CheckValid())">@ButtonText</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Guid EntityDefinitionId { get; set; }
    [Parameter] public Guid? CurrentInstance { get; set; }
    [Parameter] public string ButtonText { get; set; } = string.Empty;

    private EntityDefinition? EntityDefinition;
    private MudForm form = default!;
    private EntityInstanceI model = new();
    private string? error;
    private bool valid;

    protected override async Task OnInitializedAsync()
    {
        EntityDefinition = (await EDS.GetEntityDefinitionAsync(EntityDefinitionId)).Value;
        if (EntityDefinition == null)
            error = "Could not load the entity definition. Cannot create instance.";
        else if (CurrentInstance == null)
            foreach (FieldDefinition field in EntityDefinition.Fields)
                model.Data[field.Name] = field.IsList ? new List<object>() : GetDefaultValue(field.DataType, field.IsRequired);
        else
        {
            Result<EntityInstance> result = await EIS.GetInstanceAsync(CurrentInstance.Value);
            if (!result.IsSuccess || result.Value == null)
                error = result.Exception == null ? "Could not load the instance to edit." : result.Exception.Message;
            else
            {
                model.Data = result.Value.Data.ToDictionary(kvp => kvp.Key, kvp => (object?)kvp.Value);
                foreach (FieldDefinition field in EntityDefinition.Fields)
                    if (model.Data.TryGetValue(field.Name, out var value) && value is JsonElement je)
                        model.Data[field.Name] = ConvertJsonElement(je, field.DataType, field.IsList);
                    else if (!model.Data.ContainsKey(field.Name))
                        model.Data[field.Name] = field.IsList ? new List<object>() : GetDefaultValue(field.DataType, field.IsRequired);
            }
        }
    }

    private object? ConvertJsonElement(JsonElement je, DataType dataType, bool isList)
    {
        if (isList)
            return je.ValueKind == JsonValueKind.Array
                ? je.EnumerateArray()
                    .Select(e => ConvertJsonElement(e, dataType, false))
                    .Where(i => i != null)
                    .Cast<object>()
                    .ToList<object>()
                : new List<object>();

        return dataType switch
        {
            DataType.Text => je.ToString(),
            DataType.Number => je.TryGetDouble(out var d) ? d : (double?)null,
            DataType.Date => je.TryGetDateTime(out var dt) ? dt : (DateTime?)null,
            DataType.Boolean => je.GetBoolean(),
            DataType.EntityReference => je.TryGetGuid(out var g) ? g : (Guid?)null,
            DataType.File => je.ToString(),
            _ => null
        };
    }
    private object? GetDefaultValue(DataType dataType, bool isRequired) => dataType switch
    {
        DataType.Boolean => isRequired ? false : (bool?)null,
        DataType.Number => (double?)null,
        DataType.Date => (DateTime?)null,
        DataType.EntityReference => (Guid?)null,
        DataType.Text => string.Empty,
        DataType.File => null,
        _ => null
    };
    private List<object> GetListValue(string fieldName)
    {
        if (model.Data.TryGetValue(fieldName, out object? value) && value is List<object> list)
            return list;
        model.Data[fieldName] = new List<object>();
        return (List<object>)model.Data[fieldName]!;
    }
    private async Task Submit()
    {
        await form.Validate();
        if (!CheckValid()) return;

        Dictionary<string, object?> payload = new(model.Data);
        FS.ClearCache();

        List<(int cacheIndex, string fieldName, int? listPosition)> uploads = [];

        foreach (FieldDefinition field in EntityDefinition!/*not null because CheckValid function checks that*/.Fields.Where(f => f.DataType == DataType.File))
        {
            if (!payload.TryGetValue(field.Name, out object? value) || value == null) continue;

            if (field.IsList)
            {
                if (value is List<object> fileList)
                    for (int i = 0; i < fileList.Count; i++)
                        if (fileList[i] is IBrowserFile browserFile)
                            uploads.Add((FS.Cache(browserFile), field.Name, i));
            }
            else if (value is IBrowserFile file)
                uploads.Add((FS.Cache(file), field.Name, null));
        }

        if (uploads.Any())
        {
            Task<IEnumerable<string?>> uploadTask = FS.Upload();
            // TODO: somehow not block and display file uploading progress
            /*temp*/ var uploadResults = await uploadTask;


            string?[] resultsArr = [.. uploadResults];
            Dictionary<int, string?> results = uploads.Select((map, i) => (map.cacheIndex, resultsArr[i])).ToDictionary(t => t.cacheIndex, t => t.Item2);
            foreach ((int cacheIndex, string fieldName, int? listPosition) entry in uploads)
                if (results.TryGetValue(entry.cacheIndex, out string? newFileName) && newFileName != null)
                    if (entry.listPosition == null)
                        payload[entry.fieldName] = newFileName;
                    else if (payload[entry.fieldName] is List<object> fileList)
                        fileList[entry.listPosition.Value] = newFileName;
        }

        foreach (FieldDefinition field in EntityDefinition.Fields)
        {
            if (!payload.TryGetValue(field.Name, out object? value)) continue;

            if (field.DataType == DataType.File)
                if (field.IsList && value is List<object> objectList)
                    payload[field.Name] = objectList.OfType<string>().ToList();
                else if (value is not string && value != null)
                    payload[field.Name] = value.ToString() + "*[AUTOMATICALLY CONVERTED TO STRING]"; // don't forget, when fetching files to remove anything after the star sign

            if (!field.IsRequired)
                if (value == null)
                    payload.Remove(field.Name);
                else if (value is System.Collections.IList list && list.Count == 0)
                    payload.Remove(field.Name);
                else if (value is string str && string.IsNullOrWhiteSpace(str))
                    payload.Remove(field.Name);
        }

        if (CurrentInstance == null)
        {
            Task<Result<EntityInstance>> resultTask = EIS.CreateInstanceAsync(EntityDefinitionId, new() { Data = payload });
            // TODO: don't block, but signal ongoing operation
            /*temp*/ var result = await resultTask;

            if (result.IsSuccess)
            {
                MudDialog.Close(DialogResult.Ok(result.Value));
                return;
            }
            error = GetErrorMessage(result, "create");
        }
        else
        {
            Task<Result> resultTask = EIS.UpdateInstanceAsync(CurrentInstance.Value, new() { Data = payload });
            // TODO: don't block, but signal ongoing operation
            /*temp*/ var result = await resultTask;

            if (result.IsSuccess)
            {
                MudDialog.Close(DialogResult.Ok((await EIS.GetInstanceAsync(CurrentInstance.Value)).Value));
                return;
            }
            error = GetErrorMessage(result, "update");
        }
    }

    private string GetErrorMessage(Result result, string action)
    {
        if (result.StatusCode == null)
            return $"Failed to {action} instance. No response from server.";
        else
            return $"Failed to {action} instance. {result.Exception?.Message}";
    }
    private bool CheckValid()
    {
        if (!valid) return false;
        if (EntityDefinition == null) return false;

        foreach (FieldDefinition field in EntityDefinition.Fields.Where(f => f.IsList && f.IsRequired))
            if (model.Data.TryGetValue(field.Name, out object? value) && value is List<object> list && list.Count == 0)
                return false;
        return true;
    }
    private void Cancel() => MudDialog.Cancel();
}