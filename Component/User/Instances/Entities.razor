@page "/Entities/{EntityIdstr}"
@inject IEntityInstanceService EIS
@inject IEntityDefinitionService EDS
@inject IDialogService DS
@inject INotificationService NS
@inject NavigationManager NM

<DataLoader LoadAction="LoadDefinition">
    <Loading>
        <PageTitle>Instances</PageTitle>
        <MudText Typo="Typo.h6">Instances</MudText>
    </Loading>
    <Loaded>
        <PageTitle>Instances of @_entityDefinition.Name</PageTitle>
        <DefinitionDescription EntityDefinition="_entityDefinition" />
        <DataLoaderT @ref="_dataLoader" TArg="bool" LoadAction="LoadInstances">
            <MudTable Items="_filteredEntityInstances" Bordered="true" Hover="true" Breakpoint="Breakpoint.None" Style="white-space: nowrap;" OnRowClick="(TableRowClickEventArgs<EntityInstance> args) => OpenInstance(args)">
                <ToolBarContent>
                    <MudIconButton OnClick="@(() => NM.NavigateTo("/"))" Icon="@Icons.Material.Filled.ArrowBack" Variant="Variant.Outlined" Color="Color.Secondary" Style="margin: 0px 10px 0px 0px;" />
                    <MudIconButton OnClick="() => _dataLoader.Refresh(true)" Icon="@Icons.Material.Filled.Refresh" Variant="Variant.Outlined" Color="Color.Tertiary" />
                    <MudSpacer />
                    <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Small" Class="ml-4" DebounceInterval="100" OnDebounceIntervalElapsed="Filter" />
                    <MudSpacer />
                    <MudButton OnClick="() => OpenInstanceDialog()" Variant="Variant.Outlined" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">Create Instance</MudButton>
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Fields</MudTh>
                    <MudTh Style="width: 1%;">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Fields" Style="max-width: 1px;">
                        <MudStack Row="true" Spacing="3" Class="mud-typography-body1" Style="overflow: hidden;">
                            @foreach (KeyValuePair<string, object?> field in context.Data)
                            {
                                <div>
                                    <strong>@field.Key:</strong>
                                    <FieldValueDisplay Value="@field.Value" />
                                </div>
                            }
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="width: 1%;">
                        <MudIconButton OnClick="() => OpenInstanceDialog(context)" Icon="@Icons.Material.Filled.Edit" Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" Class="ma-1" />
                        <MudIconButton OnClick="() => OpenDeleteDialog(context)" Icon="@Icons.Material.Filled.Delete" Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" Class="ma-1" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </DataLoaderT>
    </Loaded>
</DataLoader>

@code {
    [Parameter] public string EntityIdstr { get; set; } = string.Empty;
    private Guid EntityId;

    private DataLoaderT<bool> _dataLoader = null!;

    private List<EntityInstance> _entityInstances = null!;
    private List<EntityInstance>? _filteredEntityInstances;
    private EntityDefinition _entityDefinition = null!;
    private string _searchString = string.Empty;

    private async Task<List<string>> LoadDefinition(bool refresh)
    {
        List<string> errors = [];

        if (!Guid.TryParse(EntityIdstr, out Guid entityId))
        {
            await NS.Show($"'{EntityIdstr}' is not a valid ID.");
            errors.Add($"Failed to get instance ID from the URL.");
            return errors;
        }
        EntityId = entityId;

        Result<EntityDefinition> defResult = await EDS.GetEntityDefinitionAsync(EntityId);
        if (!defResult.IsSuccess)
        {
            errors.Add("Failed to get entity definition.");
            return errors;
        }
        _entityDefinition = defResult.Value;

        return errors;
    }
    private async Task<List<string>> LoadInstances(bool refresh, bool reload)
    {
        List<string> errors = [];

        Result<List<EntityInstance>> instResult = await EIS.GetInstancesAsync(EntityId, reload);
        if (instResult.IsSuccess)
        {
            _entityInstances = instResult.Value;
            Filter();
        }
        else if (instResult.StatusCode == System.Net.HttpStatusCode.NotFound)
        {
            await NS.Show("Could not find entity definition in database.", Severity.Warning);
            NM.NavigateTo("/");
        }
        else
            errors.Add(instResult.Exception == null ? "Failed to get entity instances." : instResult.Exception.Message);

        return errors;
    }

    private void Filter()
    {
        if (_entityInstances != null)
            _filteredEntityInstances = [.. InstanceUtils.FilterInstances(_entityInstances, _searchString)];
    }

    private void OpenInstance(TableRowClickEventArgs<EntityInstance> args)
    {
        if (args.Item == null)
            return;

        NM.NavigateTo($"/Instances/{args.Item.Id}");
    }
    private async Task OpenInstanceDialog(EntityInstance? context = null)
    {
        DialogOptions options = new()
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            BackdropClick = false
        };
        DialogParameters<InstanceDialog> parameters = new()
        {
            { x => x.ButtonText, context == null ? "Create" : "Save" },
            { x => x.EntityDefinitionId, EntityId },
            { x => x.CurrentInstance, context?.Id }
        };

        IDialogReference dialog = await DS.ShowAsync<InstanceDialog>(context == null ? "Create New Entity Instance" : "Edit Entity Instance", parameters, options);
        DialogResult? result = await dialog.Result;
        if (result == null || result.Canceled || result.Data is not EntityInstance instance)
            return;

        await _dataLoader.Refresh(false);

        if (context == null) await NS.Show("Instance created successfully.", Severity.Success);
        else await NS.Show("Instance updated successfully.", Severity.Success);
        StateHasChanged();
    }
    private async Task OpenDeleteDialog(EntityInstance context)
    {
        DialogOptions options = new()
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            BackdropClick = false
        };
        DialogParameters<ConfirmationDialog> parameters = new()
        {
            {
                x => x.Content,
                @<MudText>
                    Are you sure you want to delete the selected instance?
                    <br />
                    <strong>This action cannot be undone</strong>
                </MudText>
            },
            { x => x.ButtonText, "Delete" },
            { x => x.ButtonColor, Color.Error },
            { x => x.ButtonStartIcon, Icons.Material.Filled.DeleteForever },
            {
            x => x.OnSubmit,
                async () =>
                {
                    Result result = await EIS.DeleteInstanceAsync(context.Id);
                    if (result.StatusCode != System.Net.HttpStatusCode.Conflict)
                    {
                        if (result.StatusCode != System.Net.HttpStatusCode.NotFound)
                            return result.IsSuccess;
                        else
                        {
                            await NS.Show("Instance not found.", Severity.Warning);
                            await _dataLoader.Refresh(true);
                            return true;
                        }
                    }

                    DialogParameters<ConfirmationDialog> innerParameters = new()
                    {
                        {
                            x => x.Content,
                            @<MudText>
                                This instance is referenced
                                <br />
                                <strong>Are you really sure you want to delete this instance?</strong>
                            </MudText>
                        },
                        { x => x.ButtonText, "Force Delete" },
                        { x => x.ButtonColor, Color.Error },
                        { x => x.ButtonStartIcon, Icons.Material.Filled.DeleteForever },
                        { x => x.OnSubmit, async () => (await EIS.DeleteInstanceAsync(context.Id, true)).IsSuccess }
                };

                IDialogReference dialog = await DS.ShowAsync<ConfirmationDialog>("Force Delete", innerParameters, options);
                DialogResult? dresult = await dialog.Result;
                if (dresult != null && !dresult.Canceled && dresult.Data != null && dresult.Data is bool)
                    return (bool)dresult.Data;
                return false;
                }
            },
            { x => x.ErrorMessage, "Failed to delete the entity instance."}
        };

        IDialogReference dialog = await DS.ShowAsync<ConfirmationDialog>("Confirm Deletion", parameters, options);
        DialogResult? result = await dialog.Result;
        if (result == null || result.Canceled)
            return;

        if (result.Data is bool && (bool)result.Data)
        {
            if (_entityInstances.Contains(context) == true)
                _entityInstances.Remove(context);
            Filter();
            await NS.Show($"Successfully deleted the instance.", Severity.Success);
        }
    }
}