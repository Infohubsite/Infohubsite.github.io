@page "/login"
@attribute [AllowAnonymous]
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations
@inject IAccountManagement Acct

<PageTitle>Login</PageTitle>

<MudGrid Justify="Justify.Center" Class="mt-16">
    <MudItem xs="12" sm="8" md="6" lg="4">

        @if (errors)
        {
            <MudPaper Class="pa-4" Elevation="0">
                @foreach (string error in errorList)
                {
                    <MudAlert Severity="Severity.Error" Class="mb-2">@error</MudAlert>
                }
            </MudPaper>
        }

        <EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
            <DataAnnotationsValidator />

            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h5">Login</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudTextField Label="Username"
                                  @bind-Value="loginModel.Username"
                                  For="@(() => loginModel.Username)"
                                  Required="true" />

                    <MudTextField Label="Password" Class="mt-3"
                                  @bind-Value="loginModel.Password"
                                  For="@(() => loginModel.Password)"
                                  InputType="InputType.Password"
                                  Required="true" />
                </MudCardContent>
                <MudCardActions>
                    <MudButton ButtonType="ButtonType.Submit"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               Disabled="@loading"
                               Loading="@loading"
                               Class="ml-auto">
                        Login
                    </MudButton>
                </MudCardActions>
            </MudCard>
        </EditForm>
    </MudItem>
</MudGrid>


@code {
    private bool loading, errors = false;
    private string[] errorList = [];
    private LoginModel loginModel = new();
    private object _lock = new();

    public class LoginModel
    {
        [Required]
        public string Username { get; set; } = "";

        [Required]
        public string Password { get; set; } = "";
    }

    private async Task HandleLogin()
    {
        bool taken = false;
        try
        {
            Monitor.TryEnter(_lock, 0, ref taken);

            if (taken)
            {
                loading = true;
                errors = false;
                errorList = [];

                var result = await Acct.LoginAsync(loginModel.Username, loginModel.Password);
                if (!result.Succeeded)
                {
                    errors = true;
                    errorList = result.ErrorList;
                }
            }
        }
        catch (Exception ex)
        {
            errors = true;
            errorList = [$"Unknown exception occoured: {ex}"];
        }
        finally
        {
            if (taken)
            {
                loading = false;
                Monitor.Exit(_lock);
            }
        }
    }
}