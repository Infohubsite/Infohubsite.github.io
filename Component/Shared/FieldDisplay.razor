@inject IEntityInstanceService EIS

@switch (DataType)
{
    case DataType.Text:
        <MudTextField
            @ref="_textField"
            T="string"
            Label="@FieldName"
            Required="Required"
            RequiredError="@($"{FieldName} is required.")"
            Value="@((string?)Value)"
            ValueChanged="@(async (string val) => await OnValueChanged(val))"
            @attributes="AdditionalAttributes" />
        break;
    case DataType.Number:
        <MudNumericField
            @ref="_numericField"
            T="double"
            Label="@FieldName"
            Required="Required"
            RequiredError="@($"{FieldName} is required.")"
            Value="@((double?)Value == null ? 0 : (double)Value)"
            ValueChanged="@(async (double val) => await OnValueChanged(val))"
            Validation="@((double? v) => v == null && Required ? new[] { $"{FieldName} is required." } : Enumerable.Empty<string>())"
            @attributes="AdditionalAttributes" />
        break;
    case DataType.Date:
        <MudDatePicker
            @ref="_datePicker"
            Label="@FieldName"
            Required="Required"
            RequiredError="@($"{FieldName} is required.")"
            Date="@((DateTime?)Value)"
            DateChanged="@(async (DateTime? val) => await OnValueChanged(val))"
            Clearable="!Required"
            @attributes="AdditionalAttributes" />
        break;
    case DataType.Boolean:
        @if (Required)
        {
            <MudSwitch
                T="bool"
                Label="@FieldName"
                Color="Color.Primary"
                Value="GetBoolValue()"
                ValueChanged="@(async (bool val) => await OnValueChanged(val))"
                @attributes="AdditionalAttributes" />
        }
        else
        {
            <MudSelect @ref="_selectBool" T="bool?" Label="@FieldName" Value="@((bool?)Value)" ValueChanged="@(async (bool? val) => await OnValueChanged(val))" @attributes="AdditionalAttributes">
                <MudSelectItem Value="(bool?)null"> </MudSelectItem>
                <MudSelectItem Value="(bool?)true">True</MudSelectItem>
                <MudSelectItem Value="(bool?)false">False</MudSelectItem>
            </MudSelect>
        }
        break;
    case DataType.EntityReference:
        <MudAutocomplete
            @ref="_autocomplete"
            T="EntityInstance"
            Label="@FieldName"
            Required="Required"
            RequiredError="@($"{FieldName} is required.")"
            SearchFunc="@SearchInstances"
            Value="selectedInstance"
            ValueChanged="OnInstanceSelected"
            ToStringFunc="@(instance => instance == null ? "" : GetInstanceDisplayName(instance))"
            Clearable="!Required"
            @attributes="AdditionalAttributes" />
        break;
    case DataType.File:
        <div class="d-flex align-center">
            <MudFileUpload @ref="_fileUpload" T="IBrowserFile" Required="Required" FilesChanged="@(async (val) => await OnValueChanged(val))" AppendMultipleFiles="false" Class="d-flex">
                <ActivatorContent>
                    <MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload">
                        @FieldName
                    </MudButton>
                </ActivatorContent>
            </MudFileUpload>

            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                @if (Value is IBrowserFile file)
                {
                    <MudText Class="ml-4"><strong>Selected:</strong> @file.Name</MudText>
                }
                else if (Value is string name)
                {
                    <MudText Class="ml-4"><strong>Selected:</strong> @name</MudText>
                }
                else
                {
                    <MudText Class="ml-4">No file selected</MudText>
                }
            </div>

            <MudSpacer />

            @if (!Required && Value != null && !string.IsNullOrEmpty(Value.ToString()))
            {
                <MudIconButton Icon="@Icons.Material.Filled.Clear" title="Clear" OnClick="@(async () => await OnValueChanged(null))" Class="ml-2" />
            }

            @if (_originalFileValue != null && ((Value is string s && !string.Equals(_originalFileValue, s)) || (Value is IBrowserFile f && !string.Equals(_originalFileValue, f.Name)) || !string.Equals(_originalFileValue, Value?.ToString())))
            {
                <MudIconButton Icon="@Icons.Material.Filled.Undo" title="Undo" OnClick="@(async () => await OnValueChanged(_originalFileValue))" Class="ml-2" />
            }
        </div>
        break;
}

@code {
    [Parameter, EditorRequired] public string FieldName { get; set; }
    [Parameter, EditorRequired] public DataType DataType { get; set; }
    [Parameter, EditorRequired] public bool Required { get; set; }
    [Parameter] public Guid? ReferenceTargetEntityDefinitionId { get; set; }
    [Parameter] public object? Value { get; set; }
    [Parameter(CaptureUnmatchedValues = true)] public Dictionary<string, object> AdditionalAttributes { get; set; } = [];
    [Parameter] public EventCallback<object?> ValueChanged { get; set; }

    private EntityInstance? selectedInstance;

    private MudTextField<string>? _textField;
    private MudNumericField<double>? _numericField;
    private MudDatePicker? _datePicker;
    private MudSelect<bool?>? _selectBool;
    private MudAutocomplete<EntityInstance>? _autocomplete;
    private MudFileUpload<IBrowserFile>? _fileUpload;

    private string? _originalFileValue;

    public async Task Clear()
    {
        switch (DataType)
        {
            case DataType.Text when _textField != null:
                await _textField.ResetAsync();
                break;
            case DataType.Number when _numericField != null:
                await _numericField.ResetAsync();
                break;
            case DataType.Date when _datePicker != null:
                await _datePicker.ResetAsync();
                break;
            case DataType.Boolean:
                if (Required)
                    await OnValueChanged(false);
                else if (_selectBool != null)
                    await _selectBool.ResetAsync();
                break;
            case DataType.EntityReference when _autocomplete != null:
                await OnInstanceSelected(null);
                await _autocomplete.ResetAsync();
                break;
            case DataType.File when _fileUpload != null:
                await _fileUpload.ResetAsync();
                await OnValueChanged(null);
                break;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        if (DataType == DataType.File)
            _originalFileValue = Value == null ? null : new string(Value is string s ? s : ((Value is IBrowserFile f) ? f.Name : Value.ToString()));
        if (DataType == DataType.EntityReference && Value is Guid instanceId && (selectedInstance == null || selectedInstance.Id != instanceId))
            selectedInstance = (await EIS.GetInstanceAsync(instanceId)).Value;
    }

    private async Task OnValueChanged(object? value)
    {
        Value = (value is string s && string.IsNullOrWhiteSpace(s)) ? null : value;
        await ValueChanged.InvokeAsync(Value);
    }
    private async Task OnInstanceSelected(EntityInstance? instance)
    {
        selectedInstance = instance;
        await OnValueChanged(instance?.Id);
    }
    private async Task<IEnumerable<EntityInstance>> SearchInstances(string search, CancellationToken token)
    {
        if (!ReferenceTargetEntityDefinitionId.HasValue) return Enumerable.Empty<EntityInstance>();

        List<EntityInstance> instances = (await EIS.GetInstancesAsync(ReferenceTargetEntityDefinitionId.Value)).Value ?? [];
        return InstanceUtils.FilterInstances(instances, search);
    }
    private string GetInstanceDisplayName(EntityInstance instance)
    {
        if (instance.Data == null) return instance.Id.ToString();
        if (instance.Data.Count == 0) return "(no data)";

        string? displayNameKey = instance.Data.Keys.FirstOrDefault(k => k.Equals("Name", StringComparison.OrdinalIgnoreCase))
                          ?? instance.Data.Keys.FirstOrDefault(k => k.Equals("Title", StringComparison.OrdinalIgnoreCase));

        if (displayNameKey != null && instance.Data.TryGetValue(displayNameKey, out var displayNameValue) && displayNameValue != null)
            return InstanceUtils.FormatValue(displayNameValue);

        string? displayName = instance.Data
            .Where(kvp => kvp.Value is JsonElement je && je.ValueKind == JsonValueKind.String && !Guid.TryParse(je.GetString(), out _))
            .Select(kvp => kvp.Value?.ToString())
            .FirstOrDefault(v => !string.IsNullOrWhiteSpace(v));

        if (!string.IsNullOrWhiteSpace(displayName)) return displayName;

        string? concatenatedProperties = string.Join(" | ", instance.Data
            .Where(kvp => kvp.Value != null && !(kvp.Value is JsonElement je && je.ValueKind == JsonValueKind.Null))
            .Take(3)
            .Select(kvp => $"{kvp.Key}: {InstanceUtils.FormatValue(kvp.Value)}"));

        return !string.IsNullOrWhiteSpace(concatenatedProperties) ? concatenatedProperties : instance.Id.ToString();
    }

    private bool GetBoolValue() => Value is bool boolv ? boolv : false;
}