<div class="d-flex align-center">
    <div style="overflow: hidden;">
        <FieldDisplay @ref="display" FieldName="@Label" DataType="DataType" Required="Required && Values.Count == 0" ReferenceTargetEntityDefinitionId="ReferenceTargetEntityDefinitionId" @bind-Value="value" />
    </div>
    <MudSpacer />
    <MudButton OnClick="AddChip"
               Variant="Variant.Filled"
               Color="Color.Primary">Add</MudButton>
</div>

<div class="mt-2">
    @foreach (object chip in Values)
    {
        <MudChip T="string" Color="Color.Secondary" OnClose="() => RemoveChip(chip)">
            <MudText Style="overflow: hidden; white-space: nowrap;">
                @if (DataType == DataType.EntityReference && chip is Guid guid)
                {
                    <GuidRenderer CurrentDepth="0" InstanceId="guid" />
                }
                else if (DataType == DataType.File && chip is IBrowserFile file)
                {
                    @file.Name
                }
                else
                {
                    @chip
                }
            </MudText>
        </MudChip>
    }
</div>

@code {
    [Parameter, EditorRequired] public string Label { get; set; }
    [Parameter, EditorRequired] public DataType DataType { get; set; }
    [Parameter, EditorRequired] public bool Required { get; set; }
    [Parameter] public Guid? ReferenceTargetEntityDefinitionId { get; set; }
    [Parameter] public List<object> Values { get; set; } = [];
    [Parameter] public EventCallback<List<object>> ValuesChanged { get; set; }

    private FieldDisplay display = default!;

    private object? value;

    private async Task OnKeyDown(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
            await AddChip();
    }

    private async Task AddChip()
    {
        if (value == null)
            return;
        Values.Add(value);
        value = null;
        await display.Clear();
        await ValuesChanged.InvokeAsync(Values);
    }

    private Task RemoveChip(object chip)
    {
        Values.Remove(chip);
        return ValuesChanged.InvokeAsync(Values);
    }
}